<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Mark Sheet & Reporting System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base styles */
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Modal Styling (Replaces alert/confirm) */
        #custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* Controlled by JavaScript */
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        /* Styles for PDF/Print functionality */
        @media print {
            .no-print { display: none !important; }
            #main-content-area { 
                padding: 0 !important; 
                margin: 0 !important; 
                box-shadow: none !important;
            }
            #progress-report-print {
                width: 8.5in;
                min-height: 11in;
                margin: 0;
                padding: 0.5in;
                box-shadow: none;
                border: none;
                background-color: white !important;
                color: black !important;
                /* Ensure print respects grade coloring */
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Custom Confirmation Modal (Replaces window.confirm) -->
    <div id="custom-modal">
        <div id="modal-content" class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <p id="modal-message" class="text-lg font-medium text-gray-800 mb-4"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">Cancel</button>
                <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 flex items-center justify-center bg-gray-100 z-50">
        <div class="text-2xl text-indigo-600 font-semibold flex items-center space-x-3">
            <svg class="animate-spin h-6 w-6 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span>Loading Application and Data...</span>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="min-h-screen flex hidden">
        
        <!-- Sidebar Menu -->
        <div id="sidebar-menu" class="no-print w-full md:w-64 bg-gray-50 border-r border-gray-200 p-6 space-y-6 flex-shrink-0">
            <!-- Content dynamically injected by renderSidebar() -->
        </div>

        <!-- Main Content Area -->
        <main id="main-content-area" class="flex-grow p-4 md:p-8 overflow-y-auto">
            <div class="max-w-7xl mx-auto space-y-8">
                <!-- Content dynamically injected by render() -->
            </div>
        </main>
    </div>

    <script type="module">
        // --- GLOBAL APP STATE AND LOCAL STORAGE SETUP ---
        
        // Base structure for new exams/reset
        const INITIAL_DATA = {
            institution: {
                name: 'IFER Academy',
                address: '123 Academic Way, Education City',
                logoUrl: 'https://placehold.co/100x40/4F46E5/ffffff?text=LOGO',
                examName: 'Annual Examinations 2024',
            },
            subjects: [
                { id: 'sub-math', name: 'Mathematics', maxMark: 100, isComposite: false, streamFilter: null, subSubjects: [] },
                { id: 'sub-phy', name: 'Physics', maxMark: 70, isComposite: false, streamFilter: 'Biology Science', subSubjects: [] },
                { id: 'sub-chem', name: 'Chemistry', maxMark: 70, isComposite: false, streamFilter: 'Biology Science', subSubjects: [] },
                { id: 'sub-cs', name: 'Computer Science Theory', maxMark: 70, isComposite: false, streamFilter: 'Computer Science', subSubjects: [] },
                { id: 'sub-acc', name: 'Accountancy', maxMark: 100, isComposite: false, streamFilter: 'Commerce', subSubjects: [] },
            ],
            students: [],
            nextStudentId: 1,
        };

        const GRADE_SCALE = [
            { threshold: 90, grade: 'A+', color: 'text-green-600', bgColor: 'bg-green-100' },
            { threshold: 80, grade: 'A', color: 'text-gray-900', bgColor: 'bg-gray-100' },
            { threshold: 70, grade: 'B+', color: 'text-gray-900', bgColor: 'bg-gray-100' },
            { threshold: 60, grade: 'B', color: 'text-gray-900', bgColor: 'bg-gray-100' },
            { threshold: 50, grade: 'C+', color: 'text-gray-900', bgColor: 'bg-gray-100' },
            { threshold: 40, grade: 'C', color: 'text-gray-900', bgColor: 'bg-gray-100' },
            { threshold: 30, grade: 'D+', color: 'text-gray-900', bgColor: 'bg-gray-100' },
            { threshold: 0, grade: 'F', color: 'text-red-600', bgColor: 'bg-red-100' },
        ];
        
        const STREAMS = ['Computer Science', 'Biology Science', 'Commerce']; // Defined streams

        // Local Storage Keys
        const LS_KEY_EXAMS = 'MARK_SHEET_EXAM_LIST';
        const LS_KEY_CURRENT_EXAM = 'MARK_SHEET_CURRENT_EXAM_ID';
        const LS_KEY_DATA_PREFIX = 'MARK_SHEET_DATA_';

        let appState = {
            data: INITIAL_DATA,
            rankedStudents: [],
            activeTab: 'marksheet', // 'marksheet', 'reports', 'settings'
            selectedStudentId: null,
            uploadMessage: '',
            isAuthReady: false,
            // Simulating a stable user ID for local storage key segregation
            userId: 'LOCAL_USER', 
            currentExamId: 'default-exam',
            examList: [],
            saveTimer: null,
        };

        // --- Custom Confirmation Modal Logic ---
        let resolveModalPromise;

        const showConfirmationModal = (message) => {
            return new Promise((resolve) => {
                resolveModalPromise = resolve;
                document.getElementById('modal-message').textContent = message;
                document.getElementById('custom-modal').style.display = 'flex';
            });
        };

        const setupModalListeners = () => {
            document.getElementById('modal-confirm').onclick = () => {
                document.getElementById('custom-modal').style.display = 'none';
                if (resolveModalPromise) resolveModalPromise(true);
            };
            document.getElementById('modal-cancel').onclick = () => {
                document.getElementById('custom-modal').style.display = 'none';
                if (resolveModalPromise) resolveModalPromise(false);
            };
        };


        /** Utility: Converts a file object to a Base64 data URL */
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };

        /** Utility: Grade Calculation */
        const calculateGrade = (score, maxMark) => {
            if (maxMark === 0) return { grade: 'N/A', color: 'text-gray-400', bgColor: 'bg-gray-50', percentage: '0.00' };
            const percentage = (score / maxMark) * 100;
            for (const scale of GRADE_SCALE) {
                if (percentage >= scale.threshold) {
                    return { grade: scale.grade, color: scale.color, bgColor: scale.bgColor, percentage: percentage.toFixed(2) };
                }
            }
            return { grade: 'F', color: 'text-red-600', bgColor: 'bg-red-100', percentage: percentage.toFixed(2) };
        };

        /** Utility: Ranking and Calculation Logic */
        const rankAndCalculate = (students, subjects) => {
            
            const calculatedStudents = students.map(student => {
                
                // 1. FILTER SUBJECTS relevant to the student's stream 
                const studentSubjects = subjects.filter(subject => 
                    !subject.streamFilter || subject.streamFilter === student.stream
                );
                
                let studentTotalScore = 0;
                let studentTotalMaxMark = 0; // Max Mark calculated per student stream

                // Calculate subject scores/grades
                const newMarks = {};
                
                // Iterate over ALL subjects, but only count scores for relevant ones
                subjects.forEach(subject => { 
                    const isRelevant = !subject.streamFilter || subject.streamFilter === student.stream;
                    
                    let score = student.marks[subject.id]?.score || 0;
                    let subjectMaxMark = subject.maxMark;

                    // If composite, recalculate score from sub-subjects
                    if (subject.isComposite && subject.subSubjects.length > 0) {
                        subjectMaxMark = subject.subSubjects.reduce((sum, ss) => sum + ss.maxMark, 0);
                        // Also update the score based on sub-marks if present
                        score = subject.subSubjects.reduce((sum, ss) => sum + (student.marks[subject.id]?.subMarks?.[ss.name] || 0), 0);
                    }
                    
                    if (isRelevant) {
                        studentTotalScore += score;
                        studentTotalMaxMark += subjectMaxMark; // Add to student's specific Max Mark
                    }

                    // Store calculated grade/max mark (even for irrelevant subjects, for completeness in state)
                    newMarks[subject.id] = {
                        ...student.marks[subject.id],
                        score: score,
                        ...calculateGrade(score, subjectMaxMark),
                        maxMark: subjectMaxMark
                    };
                });
                
                const studentPercentage = studentTotalMaxMark > 0 ? (studentTotalScore / studentTotalMaxMark) * 100 : 0;

                return {
                    ...student,
                    marks: newMarks,
                    total: studentTotalScore,
                    percentage: studentPercentage.toFixed(2),
                    totalMaxMark: studentTotalMaxMark, // Store specific Max Mark
                };
            });

            // Sort and Rank
            calculatedStudents.sort((a, b) => b.total - a.total);
            let currentRank = 1;
            for (let i = 0; i < calculatedStudents.length; i++) {
                if (i > 0 && calculatedStudents[i].total < calculatedStudents[i - 1].total) {
                    currentRank = i + 1;
                }
                calculatedStudents[i].rank = currentRank;
            }

            return calculatedStudents;
        };

        // --- STATE & PERSISTENCE MANAGEMENT (Local Storage) ---

        /** Database: Save data to Local Storage (Debounced) */
        const saveData = async (updates, refreshUI = true) => {
            // 1. Update State Optimistically
            const newData = { ...appState.data, ...updates };
            newData.students = rankAndCalculate(newData.students, newData.subjects);
            appState.data = newData;
            appState.rankedStudents = newData.students;
            if (refreshUI) render();

            // 2. Persist to Local Storage (Debounced to prevent excessive writes)
            clearTimeout(appState.saveTimer);
            appState.saveTimer = setTimeout(() => {
                try {
                    // Save main exam data
                    localStorage.setItem(LS_KEY_DATA_PREFIX + appState.currentExamId, JSON.stringify(appState.data));
                    
                    // Save current exam ID
                    localStorage.setItem(LS_KEY_CURRENT_EXAM, appState.currentExamId);

                    // Save exam list (which is updated via handleAddExam)
                    localStorage.setItem(LS_KEY_EXAMS, JSON.stringify(appState.examList));

                    console.log(`Data saved locally for exam: ${appState.currentExamId}`);
                } catch (e) {
                    console.error("Error saving data to Local Storage: ", e);
                }
            }, 300); // 300ms debounce
        };

        /** Database: Switch Exam */
        window.switchExam = (examId) => {
            appState.currentExamId = examId;
            attachDataListener(); // Load the new exam's data
        };

        /** Database: Load data from Local Storage */
        const attachDataListener = () => {
            // Load exam list
            try {
                const storedExams = localStorage.getItem(LS_KEY_EXAMS);
                if (storedExams) {
                    appState.examList = JSON.parse(storedExams);
                } else {
                    appState.examList = [{ id: 'default-exam', name: 'Default Exam' }];
                }
            } catch (e) {
                console.error("Error loading exam list from local storage:", e);
                appState.examList = [{ id: 'default-exam', name: 'Default Exam' }];
            }

            // Determine current exam ID
            const storedCurrentExamId = localStorage.getItem(LS_KEY_CURRENT_EXAM);
            appState.currentExamId = storedCurrentExamId || 'default-exam';

            // Ensure current exam ID exists in the list
            if (!appState.examList.some(e => e.id === appState.currentExamId)) {
                appState.currentExamId = appState.examList[0].id;
            }

            // Load main exam data
            try {
                const storedData = localStorage.getItem(LS_KEY_DATA_PREFIX + appState.currentExamId);
                if (storedData) {
                    const loadedData = JSON.parse(storedData);
                     const mergedData = { 
                        ...INITIAL_DATA, 
                        ...loadedData, 
                        institution: { ...INITIAL_DATA.institution, ...loadedData.institution } 
                    };
                    appState.data = mergedData;
                } else {
                    // Use initial data, but update exam name from the list
                    appState.data = { ...INITIAL_DATA }; 
                }
            } catch (e) {
                console.error(`Error loading data for exam ${appState.currentExamId} from local storage:`, e);
                appState.data = { ...INITIAL_DATA };
            }

            // Final calculation and UI update
            appState.data.institution.examName = appState.examList.find(e => e.id === appState.currentExamId)?.name || 'New Examination';
            appState.rankedStudents = rankAndCalculate(appState.data.students, appState.data.subjects);
            appState.isAuthReady = true; // Ready immediately after local load
            render();
        };
        
        /** Database: Initialize Firebase (Now Local) */
        const initializeLocalData = async () => {
            // No Firebase steps, just run the data loading logic
            attachDataListener(); 
        };


        // --- UI RENDER FUNCTIONS ---

        /** Global UI render function */
        const render = () => {
            const loadingScreen = document.getElementById('loading-screen');
            const appContainer = document.getElementById('app-container');

            if (!appState.isAuthReady) {
                loadingScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
                return;
            }

            loadingScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');

            renderSidebar();
            
            const mainContent = document.getElementById('main-content-area');
            mainContent.innerHTML = ''; // Clear previous content

            let contentHtml = '';
            switch (appState.activeTab) {
                case 'marksheet':
                    contentHtml = renderMarksheetTab();
                    break;
                case 'reports':
                    contentHtml = renderReportsTab();
                    break;
                case 'settings':
                    contentHtml = renderSettingsTab();
                    break;
            }
            mainContent.innerHTML = `<div class="max-w-7xl mx-auto space-y-8">${contentHtml}</div>`;
            
            // Reattach all specific event listeners after DOM update
            attachEventListeners();
        };

        const setActiveTab = (tab) => {
            appState.activeTab = tab;
            render();
        };

        const renderSidebar = () => {
            const sidebar = document.getElementById('sidebar-menu');
            if (!sidebar) return;

            // Navigation
            let navHtml = ['Marksheet', 'Reports', 'Settings'].map(name => {
                const tab = name.toLowerCase().replace(' ', '');
                const isActive = appState.activeTab === tab;
                return `
                    <button onclick="setActiveTab('${tab}')" class="w-full text-left p-3 rounded-lg font-medium transition-colors ${
                        isActive ? 'bg-indigo-600 text-white shadow-lg' : 'text-gray-700 hover:bg-gray-200'
                    }">
                        ${name}
                    </button>
                `;
            }).join('');
            
            // Exam Selector
            const examOptionsHtml = appState.examList.map(exam => `
                <button
                    onclick="switchExam('${exam.id}')"
                    class="w-full text-left text-sm p-2 rounded-md transition-colors mb-1 truncate ${
                        appState.currentExamId === exam.id ? 'bg-indigo-100 text-indigo-700 font-bold' : 'text-gray-600 hover:bg-gray-100'
                    }"
                    title="${exam.name}"
                >
                    ${exam.name}
                </button>
            `).join('');

            const sidebarHtml = `
                <h2 class="text-2xl font-bold text-indigo-700 mb-4">Navigation</h2>
                <div class="space-y-2">
                    ${navHtml}
                </div>
                
                <div class="border-t border-gray-200 pt-4 mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Exam Selector</h3>
                    ${examOptionsHtml}
                    <div class="mt-4 flex space-x-2" id="add-exam-form">
                        <input type="text" id="new-exam-name" placeholder="New Exam Name" class="flex-grow p-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500"/>
                        <button id="btn-add-exam" class="px-4 py-2 bg-indigo-500 text-white text-sm rounded-lg hover:bg-indigo-600 transition-colors">Add</button>
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-4 mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Data Storage</h3>
                    <p class="text-xs break-all bg-yellow-100 p-2 rounded-lg text-yellow-700">
                        All data is saved locally in your browser's Local Storage. It will persist until you clear your browser data or switch devices.
                    </p>
                </div>
            `;
            sidebar.innerHTML = sidebarHtml;
        };
        
        // --- Tab Renderers ---

        const renderMarksheetTable = (students, subjects) => {
            
            const headerCells = subjects.map(s => `
                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase whitespace-nowrap">
                    ${s.name} (/${s.maxMark}${s.streamFilter ? ' - ' + s.streamFilter.split(' ')[0] : ''})
                </th>
            `).join('');

            const studentRows = students.map(student => {
                const markCells = subjects.map(subject => {
                    const markEntry = student.marks[subject.id] || {};
                    const isRelevant = !subject.streamFilter || subject.streamFilter === student.stream;
                    
                    let cellContent = '';
                    if (isRelevant) {
                        cellContent = `
                            <div class="p-1 rounded-md ${markEntry.bgColor || 'bg-gray-100'}">
                                <span class="font-mono font-medium text-gray-800">${markEntry.score || 0}</span>
                                <span class="block text-xs font-bold ${markEntry.color || 'text-gray-500'}">${markEntry.grade || 'N/A'}</span>
                            </div>
                        `;
                    } else {
                        cellContent = `<span class="text-xs text-gray-400 font-mono">N/A</span>`;
                    }

                    return `<td class="px-3 py-2 text-sm text-center">${cellContent}</td>`;
                }).join('');

                return `
                    <tr class="hover:bg-indigo-50/50 transition-colors">
                        <td class="px-3 py-2 text-sm text-gray-900 font-semibold text-center">${student.rank}</td>
                        <td class="px-3 py-2 text-sm text-gray-900">${student.name}</td>
                        <td class="px-3 py-2 text-sm text-gray-500">${student.stream}</td>
                        ${markCells}
                        <td class="px-3 py-2 text-sm font-bold text-center text-indigo-700">
                            ${student.total}
                            <span class="block text-xs font-normal text-gray-500">/${student.totalMaxMark}</span>
                        </td>
                        <td class="px-3 py-2 text-sm font-semibold text-center">${student.percentage}%</td>
                        <td class="px-3 py-2 text-center no-print">
                            <button data-student-id="${student.id}" class="text-xs text-indigo-600 hover:text-indigo-800 font-medium transition-colors view-report-btn">
                                View Report
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            const emptyRow = students.length === 0 ? `
                <tr><td colspan="${subjects.length + 5}" class="py-4 text-center text-gray-500">No student data available. Please add students or upload marks.</td></tr>
            ` : '';

            const instHeader = `
                <div class="text-center mb-6 border-b pb-3">
                    <img src="${appState.data.institution.logoUrl || 'https://placehold.co/100x40/4F46E5/ffffff?text=LOGO'}" alt="Logo" class="h-10 w-auto mx-auto mb-2 rounded-lg" onerror="this.onerror=null; this.src='https://placehold.co/100x40/4F46E5/ffffff?text=LOGO';" />
                    <h1 class="text-2xl font-bold text-indigo-700">${appState.data.institution.name}</h1>
                    <p class="text-sm text-gray-600">${appState.data.institution.address}</p>
                    <h2 class="text-xl font-semibold mt-3">Mark Sheet - ${appState.data.institution.examName}</h2>
                </div>
            `;

            return `
                <div class="overflow-x-auto shadow-xl rounded-lg bg-white p-4" id="marksheet-print-area">
                    ${instHeader}
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Rank</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Stream</th>
                                ${headerCells}
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Total Score / Max</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Percentage</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase no-print">Action</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${studentRows}
                            ${emptyRow}
                        </tbody>
                    </table>
                </div>
            `;
        };
        
        const renderMarksheetTab = () => {
            const streamOptionsHtml = STREAMS.map(stream => `<option value="${stream}">${stream}</option>`).join('');
            
            const studentEntryRows = appState.data.students.map(student => {
                const subjectInputs = appState.data.subjects.map(subject => {
                    const isRelevant = !subject.streamFilter || subject.streamFilter === student.stream;

                    if (!isRelevant) {
                        return `<td class="px-3 py-2 text-center text-gray-400 text-sm italic bg-gray-50/50">N/A</td>`;
                    }

                    if (subject.isComposite && subject.subSubjects.length > 0) {
                        const subInputs = subject.subSubjects.map(ss => `
                            <div class="flex items-center justify-center space-x-1 text-xs">
                                <label class="text-gray-600 font-medium">${ss.name} (/${ss.maxMark}):</label>
                                <input
                                    type="number" min="0" max="${ss.maxMark}"
                                    data-student-id="${student.id}" data-subject-id="${subject.id}" data-subsubject-name="${ss.name}"
                                    value="${student.marks[subject.id]?.subMarks?.[ss.name] || ''}"
                                    class="w-16 p-1 border border-gray-300 rounded-md text-center text-sm sub-mark-input"
                                />
                            </div>
                        `).join('');
                        return `<td class="px-3 py-2 text-center"><div class="space-y-1">${subInputs}</div></td>`;
                    } else {
                        return `
                            <td class="px-3 py-2 text-center">
                                <input
                                    type="number" min="0" max="${subject.maxMark}"
                                    data-student-id="${student.id}" data-subject-id="${subject.id}"
                                    value="${student.marks[subject.id]?.score || ''}"
                                    class="w-20 p-2 border border-gray-300 rounded-lg text-center font-mono mark-input"
                                />
                            </td>
                        `;
                    }
                }).join('');

                return `
                    <tr class="hover:bg-gray-50/50 transition-colors">
                        <td class="px-3 py-2 text-sm font-semibold text-gray-900 flex justify-between items-center whitespace-nowrap">
                            <span>${student.name} <span class="block text-xs font-normal text-gray-500">(${student.stream})</span></span>
                            <button data-student-id="${student.id}" class="text-xs px-2 py-1 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors delete-student-btn">
                                Remove
                            </button>
                        </td>
                        ${subjectInputs}
                    </tr>
                `;
            }).join('');

            return `
                <div class="space-y-8">
                    <h2 class="text-3xl font-extrabold text-gray-800">${appState.data.institution.examName} - Mark Sheet Entry</h2>
                    
                    <!-- Data Persistence & CSV Guide -->
                    <div class="p-4 bg-yellow-50 border-l-4 border-yellow-600 text-yellow-800 rounded-lg shadow-md">
                        <h3 class="font-bold text-lg mb-1 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L11 9.586V6z" clip-rule="evenodd"></path></svg>
                            Local Storage Warning
                        </h3>
                        <p class="text-sm">
                            Your data is **only saved in this browser**. It is not backed up and will be lost if you clear your browser cache or switch devices. Use CSV/Excel for backups!
                        </p>
                        <p class="text-sm mt-2 font-semibold text-gray-700">
                            CSV Format for Upload: <code>Name, Stream, PhotoURL, Subject1 Name, Subject2 Name, ...</code> (Marks only)
                        </p>
                    </div>


                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Add New Student -->
                        <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-100">
                            <h3 class="text-xl font-bold text-indigo-700 mb-4">Add New Student</h3>
                            <div class="space-y-3" id="add-student-form">
                                <input type="text" id="student-name-input" placeholder="Student Name" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"/>
                                <select id="student-stream-input" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                                    ${streamOptionsHtml}
                                </select>
                                
                                <label class="block text-sm font-medium text-gray-700 pt-2">Upload Photo (Optional, PNG/JPG)</label>
                                <input type="file" id="student-photo-upload" accept="image/png, image/jpeg" class="w-full file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100"/>
                                
                                <input type="url" id="student-photo-url" placeholder="or paste Photo URL" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"/>
                                
                                <button id="btn-add-student" class="w-full py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-shadow shadow-md hover:shadow-lg">
                                    Add Student
                                </button>
                            </div>
                        </div>

                        <!-- Upload Excel/CSV -->
                        <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-100">
                            <h3 class="text-xl font-bold text-indigo-700 mb-4">Upload Marks (CSV/Excel)</h3>
                            <p class="text-sm text-gray-600 mb-3">Upload a CSV file (e.g., from Google Sheets download) to update or add students/marks.</p>
                            <input type="file" accept=".csv" id="csv-upload-input" class="w-full file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                            <p id="upload-message" class="mt-3 text-sm italic text-indigo-500">${appState.uploadMessage}</p>
                        </div>
                    </div>

                    <h3 class="text-2xl font-bold text-gray-800 border-b pb-2">Student Mark Entry</h3>
                    <div class="overflow-x-auto shadow-xl rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-indigo-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-600 uppercase whitespace-nowrap">Name (Stream)</th>
                                    ${appState.data.subjects.map(s => `
                                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-600 uppercase whitespace-nowrap">
                                            ${s.name} (Max: ${s.maxMark}${s.streamFilter ? ' - ' + s.streamFilter.split(' ')[0] : ''})
                                        </th>
                                    `).join('')}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="mark-entry-table-body">
                                ${studentEntryRows}
                                ${appState.data.students.length === 0 ? `<tr><td colspan="${appState.data.subjects.length + 1}" class="py-4 text-center text-gray-500">No students added yet.</td></tr>` : ''}
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-8">
                        <h3 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">Whole Mark Sheet (Ranked)</h3>
                        ${renderMarksheetTable(appState.rankedStudents, appState.data.subjects)}
                        
                        <div class="mt-6 flex space-x-4 justify-center no-print">
                            <button id="download-marksheet-csv" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-shadow">
                                Download Mark Sheet (Excel/CSV)
                            </button>
                            <button id="download-marksheet-pdf" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-shadow">
                                Download Mark Sheet (PDF/Print)
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderProgressReportViewer = (student) => {
            if (!student) return `
                <div class="text-center p-12 bg-white rounded-xl border border-dashed border-gray-300">
                    <p class="text-lg text-gray-500">Select a student above to view their detailed progress report.</p>
                </div>
            `;
            
            const subjectRows = appState.data.subjects
                .filter(s => !s.streamFilter || s.streamFilter === student.stream) // Filter subjects for report
                .map(s => {
                    const markEntry = student.marks[s.id] || {};
                    
                    const subSubjectRows = s.isComposite && s.subSubjects.length > 0 ? 
                        s.subSubjects.map(ss => `
                            <tr class="bg-white text-gray-600 hover:bg-gray-50">
                                <td class="px-6 py-2 text-xs italic">-- ${ss.name}</td>
                                <td class="px-4 py-2 text-xs text-center">${ss.maxMark}</td>
                                <td class="px-4 py-2 text-xs text-center">${student.marks[s.id]?.subMarks?.[ss.name] || 0}</td>
                                <td colspan="2" class="px-4 py-2 text-xs text-center"></td>
                            </tr>
                        `).join('') : '';

                    return `
                        <tr class="bg-indigo-50/50">
                            <td class="px-4 py-3 text-sm font-semibold text-gray-800">${s.name}</td>
                            <td class="px-4 py-3 text-sm text-center">${markEntry.maxMark || s.maxMark}</td>
                            <td class="px-4 py-3 text-sm font-bold text-center text-gray-800">${markEntry.score || 0}</td>
                            <td class="px-4 py-3 text-sm text-center font-medium">${markEntry.percentage || '0.00'}%</td>
                            <td class="px-4 py-3 text-sm font-extrabold text-center ${markEntry.color || 'text-gray-500'}">${markEntry.grade || 'N/A'}</td>
                        </tr>
                        ${subSubjectRows}
                    `;
            }).join('');

            return `
                <div class="max-w-3xl mx-auto p-0 md:p-8">
                    <div class="bg-white border border-gray-200 rounded-xl shadow-xl space-y-6" id="progress-report-print">
                        <!-- Institution Header -->
                        <div class="flex justify-between items-start border-b-4 border-indigo-600 pb-4 mb-8">
                            <div>
                                <h1 class="text-3xl font-extrabold text-gray-800">${appState.data.institution.name}</h1>
                                <p class="text-sm text-gray-600 mt-1">${appState.data.institution.address}</p>
                                <p class="text-lg font-semibold text-indigo-600 mt-2">${appState.data.institution.examName} - Progress Report</p>
                            </div>
                            <!-- Logo Area -->
                            <img src="${appState.data.institution.logoUrl || 'https://placehold.co/100x40/4F46E5/ffffff?text=LOGO'}" alt="Logo" class="h-10 w-auto rounded-lg shadow-md" onerror="this.onerror=null; this.src='https://placehold.co/100x40/4F46E5/ffffff?text=LOGO'"/>
                        </div>

                        <!-- Student Details -->
                        <div class="flex items-center justify-between bg-indigo-50 p-4 rounded-lg">
                            <div class="space-y-1">
                                <p class="text-lg font-bold text-gray-800">Student Name: <span class="text-indigo-700">${student.name}</span></p>
                                <p class="text-md text-gray-700">Stream: <span class="font-medium">${student.stream}</span></p>
                                <p class="text-md text-gray-700">Overall Rank: <span class="font-bold bg-indigo-200 px-2 py-0.5 rounded text-indigo-800">${student.rank}</span></p>
                            </div>
                            ${student.photoUrl ? `<img src="${student.photoUrl}" alt="${student.name}'s Photo" class="w-20 h-20 object-cover rounded-full border-4 border-indigo-300 shadow-lg" onerror="this.onerror=null; this.src='https://placehold.co/80x80/cccccc/333333?text=No+Photo'"/>` : ''}
                        </div>

                        <!-- Mark Breakdown Table -->
                        <h3 class="text-2xl font-semibold text-gray-700 mt-6 border-b pb-2">Subject Performance</h3>
                        <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg overflow-hidden">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Subject</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Max Mark</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Score</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Percentage</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Grade</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-100">
                                ${subjectRows}
                            </tbody>
                        </table>

                        <!-- Summary -->
                        <div class="pt-4 mt-6 border-t border-dashed border-gray-300">
                            <h3 class="text-2xl font-semibold text-gray-700">Overall Summary</h3>
                            <div class="mt-4 grid grid-cols-3 gap-4 text-center">
                                <div class="bg-green-50 p-4 rounded-lg border-2 border-green-200">
                                    <p class="text-sm text-gray-600">Total Marks Obtained</p>
                                    <p class="text-3xl font-bold text-green-700 mt-1">${student.total}</p>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-200">
                                    <p class="text-sm text-gray-600">Total Max Mark</p>
                                    <p class="text-3xl font-bold text-blue-700 mt-1">${student.totalMaxMark}</p>
                                </div>
                                <div class="bg-indigo-50 p-4 rounded-lg border-2 border-indigo-200">
                                    <p class="text-sm text-gray-600">Overall Percentage</p>
                                    <p class="text-3xl font-bold text-indigo-700 mt-1">${student.percentage}%</p>
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-center text-gray-400 pt-4">Generated by The Mark Upload System</p>
                    </div>
                </div>
            `;
        };

        const renderReportsTab = () => {
            const selectedStudent = appState.rankedStudents.find(s => s.id === appState.selectedStudentId);
            
            const studentOptions = appState.rankedStudents.map(s => `
                <option value="${s.id}" ${s.id === appState.selectedStudentId ? 'selected' : ''}>
                    ${s.name} (Rank: ${s.rank})
                </option>
            `).join('');

            return `
                <div class="space-y-6">
                    <h2 class="text-3xl font-extrabold text-gray-800">Student Progress Reports</h2>

                    <!-- Student Selector -->
                    <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-100 flex flex-col md:flex-row items-center space-y-3 md:space-y-0 md:space-x-4 no-print">
                        <select id="student-selector" class="flex-grow w-full md:w-auto p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-800">
                            <option value="">-- Select a Student for Report --</option>
                            ${studentOptions}
                        </select>

                        ${selectedStudent ? `
                            <div class="flex space-x-3 w-full md:w-auto">
                                <button id="download-report-csv" class="w-1/2 md:w-auto px-4 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-shadow text-sm whitespace-nowrap">
                                    Download CSV
                                </button>
                                <button id="download-report-pdf" class="w-1/2 md:w-auto px-4 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-shadow text-sm whitespace-nowrap">
                                    Download PDF
                                </button>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Individual Report View -->
                    ${renderProgressReportViewer(selectedStudent)}
                </div>
            `;
        };

        const renderSettingsTab = () => {
            const streamOptionsForSubject = [''].concat(STREAMS).map(stream => 
                `<option value="${stream}" ${stream === '' ? 'selected' : ''}>${stream || 'Common (All Streams)'}</option>`
            ).join('');

            const subjectListHtml = appState.data.subjects.map(s => {
                const subSubjectList = s.subSubjects.map(ss => `
                    <div class="flex justify-between items-center text-sm ml-4 bg-gray-50 p-2 rounded-md shadow-inner">
                        <div class="flex items-center space-x-2 flex-grow">
                            <input type="text" 
                                data-parent-id="${s.id}" data-original-name="${ss.name}" data-field="name"
                                value="${ss.name}" placeholder="Sub-subject Name"
                                class="w-1/2 p-1 border border-gray-300 rounded-md text-sm subsubject-detail-input font-medium"/>
                            <span class="text-gray-500">Max:</span>
                            <input type="number" min="1" 
                                data-parent-id="${s.id}" data-original-name="${ss.name}" data-field="maxMark"
                                value="${ss.maxMark}"
                                class="w-20 p-1 border border-gray-300 rounded-md text-center text-sm subsubject-detail-input"/>
                        </div>
                        <button data-subject-id="${s.id}" data-subsubject-name="${ss.name}" class="text-xs px-3 py-1 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition-colors remove-subsubject-btn">Remove</button>
                    </div>
                `).join('');
                
                // Max Mark Control
                const maxMarkControl = s.isComposite ? 
                    `<span class="text-sm font-semibold text-indigo-500">Total: ${s.maxMark}</span>` : 
                    `<div class="flex items-center space-x-1">
                        <label class="text-sm text-gray-500 whitespace-nowrap">Max Mark:</label>
                        <input type="number" min="1" value="${s.maxMark}" data-subject-id="${s.id}" class="w-20 p-1 border border-gray-300 rounded-md text-center text-sm subject-max-mark-input"/>
                    </div>`;

                // Stream Tag Display
                const streamTag = s.streamFilter ? 
                    `<span class="text-xs font-medium text-white px-2 py-0.5 rounded-full bg-blue-500 ml-2">${s.streamFilter.split(' ')[0]} Stream</span>` : 
                    `<span class="text-xs font-medium text-gray-700 px-2 py-0.5 rounded-full bg-gray-200 ml-2">Common</span>`;


                return `
                    <div class="p-4 border border-gray-200 rounded-lg shadow-sm">
                        <div class="flex justify-between items-center flex-wrap">
                            <span class="text-lg font-semibold text-gray-800 mb-2 md:mb-0">${s.name} ${streamTag}</span>
                            <div class="flex items-center space-x-4">
                                ${maxMarkControl}
                                <div class="space-x-2">
                                    <button data-subject-id="${s.id}" class="text-xs px-3 py-1 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition-colors add-subsubject-btn">Composite Part (+)</button>
                                    <button data-subject-id="${s.id}" class="text-xs px-3 py-1 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition-colors remove-subject-btn">Remove</button>
                                </div>
                            </div>
                        </div>
                        ${s.subSubjects.length > 0 ? `<div class="mt-3 border-t pt-3 space-y-2"><p class="text-sm font-medium text-gray-600">Sub-subjects (Total Max: ${s.maxMark})</p>${subSubjectList}</div>` : ''}
                    </div>
                `;
            }).join('');

            const gradeScaleHtml = GRADE_SCALE.map(g => `
                <div class="text-center">
                    <p class="text-xs text-gray-600">Min %</p>
                    <p class="text-lg font-bold">${g.threshold}%</p>
                    <p class="text-2xl font-extrabold ${g.color} ${g.grade === 'F' || g.grade === 'A+' ? 'bg-' + g.color.replace('text-', '').replace('-600', '-100') + ' p-1 rounded' : ''}">${g.grade}</p>
                </div>
            `).join('');

            return `
                <div class="space-y-8">
                    <h2 class="text-3xl font-extrabold text-gray-800">Application Settings</h2>

                    <!-- Institution Details -->
                    <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-100">
                        <h3 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">Institution Details</h3>
                        <div class="space-y-3">
                            <input type="text" id="inst-name" placeholder="Institution Name" value="${appState.data.institution.name}" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"/>
                            <input type="text" id="inst-address" placeholder="Institution Address" value="${appState.data.institution.address}" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"/>
                            <input type="url" id="inst-logo-url" placeholder="Logo URL (Appears on reports)" value="${appState.data.institution.logoUrl}" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"/>
                            <input type="text" id="inst-examName" placeholder="Examination Name (e.g., Mid-Term 2025)" value="${appState.data.institution.examName}" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"/>
                        </div>
                    </div>

                    <!-- Subject Management -->
                    <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-100">
                        <h3 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">Subject Management</h3>
                        
                        <!-- Add Subject Form -->
                        <div class="p-4 bg-indigo-50 rounded-lg mb-6">
                            <h4 class="font-semibold text-indigo-700 mb-2">Add New Subject</h4>
                            <div class="flex flex-wrap items-end gap-3">
                                <div class="flex-grow">
                                    <label class="block text-sm font-medium text-indigo-700 mb-1">Name</label>
                                    <input type="text" id="new-subject-name" placeholder="Subject Name" class="w-full p-2 border border-gray-300 rounded-lg"/>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-indigo-700 mb-1">Max Mark (Initial)</label>
                                    <input type="number" id="new-subject-max-mark" placeholder="Max Mark" min="1" value="100" class="w-24 p-2 border border-gray-300 rounded-lg text-center"/>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-indigo-700 mb-1">Stream Filter</label>
                                    <select id="new-subject-stream" class="p-2 border border-gray-300 rounded-lg bg-white w-40 text-sm text-gray-700">
                                        ${streamOptionsForSubject}
                                    </select>
                                </div>
                                <button id="btn-add-subject" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">Add Subject</button>
                            </div>
                        </div>

                        <!-- Existing Subjects List -->
                        <div class="space-y-4">
                            ${subjectListHtml}
                            ${appState.data.subjects.length === 0 ? '<p class="text-center text-gray-500 italic">No subjects added yet. Add a subject to start!</p>' : ''}
                        </div>
                    </div>

                    <!-- Grading Scale Info -->
                    <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-100">
                        <h3 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">Grading Scale Reference</h3>
                        <div class="flex space-x-4 justify-between overflow-x-auto">
                            ${gradeScaleHtml}
                        </div>
                    </div>
                </div>
            `;
        };
        

        // --- HANDLERS AND EVENT ATTACHMENTS ---

        const handleAddExam = async () => {
            const newExamNameInput = document.getElementById('new-exam-name');
            const newExamName = newExamNameInput?.value.trim();

            if (!newExamName) return;

            const newExamId = `exam-${Date.now()}`;
            const newExamEntry = { id: newExamId, name: newExamName };
            const updatedExamList = [...appState.examList, newExamEntry];
            
            // 1. Save the updated list of exams
            localStorage.setItem(LS_KEY_EXAMS, JSON.stringify(updatedExamList));
            appState.examList = updatedExamList;

            // 2. Create the new exam's data document with initial structure
            const newExamData = { ...INITIAL_DATA, institution: { ...INITIAL_DATA.institution, examName: newExamName } };
            localStorage.setItem(LS_KEY_DATA_PREFIX + newExamId, JSON.stringify(newExamData));

            appState.currentExamId = newExamId;
            newExamNameInput.value = '';
            
            // Re-load to update UI
            attachDataListener(); 
        };

        const handleAddStudent = async () => { 
            const nameInput = document.getElementById('student-name-input');
            const streamSelect = document.getElementById('student-stream-input');
            const photoUrlInput = document.getElementById('student-photo-url');
            const photoFileInput = document.getElementById('student-photo-upload');
            
            const name = nameInput.value.trim();
            if (!name) return;

            let photoData = photoUrlInput.value.trim();
            const file = photoFileInput.files[0];

            if (file) {
                try {
                    photoData = await fileToBase64(file);
                } catch (e) {
                    console.error("Error converting file to Base64:", e);
                    photoData = ''; 
                }
            }


            const newStudent = {
                id: `s-${appState.data.nextStudentId}`,
                name: name,
                stream: streamSelect.value,
                photoUrl: photoData,
                marks: {},
            };

            const newStudents = [...appState.data.students, newStudent];
            saveData({ students: newStudents, nextStudentId: appState.data.nextStudentId + 1 });
            
            nameInput.value = '';
            photoUrlInput.value = '';
            photoFileInput.value = ''; // Clear file input after use
        };

        const handleMarkChange = (e) => {
            const studentId = e.target.dataset.studentId;
            const subjectId = e.target.dataset.subjectId;
            const score = Math.max(0, parseInt(e.target.value) || 0);

            const newStudents = appState.data.students.map(s => {
                if (s.id === studentId) {
                    return {
                        ...s,
                        marks: {
                            ...s.marks,
                            [subjectId]: {
                                ...s.marks[subjectId],
                                score: score
                            }
                        }
                    };
                }
                return s;
            });

            saveData({ students: newStudents }, false); // Do not force render, rely on debounce
        };

        const handleSubMarkChange = (e) => {
            const studentId = e.target.dataset.studentId;
            const subjectId = e.target.dataset.subjectId;
            const subSubjectName = e.target.dataset.subsubjectName;
            const score = Math.max(0, parseInt(e.target.value) || 0);

            const newStudents = appState.data.students.map(s => {
                if (s.id === studentId) {
                    const existingMarks = s.marks[subjectId] || {};
                    const existingSubMarks = existingMarks.subMarks || {};
                    
                    return {
                        ...s,
                        marks: {
                            ...s.marks,
                            [subjectId]: {
                                ...existingMarks,
                                subMarks: {
                                    ...existingSubMarks,
                                    [subSubjectName]: score
                                }
                            }
                        }
                    };
                }
                return s;
            });
            saveData({ students: newStudents }, false); // Do not force render
        };

        const handleAddSubject = () => {
            const nameInput = document.getElementById('new-subject-name');
            const maxMarkInput = document.getElementById('new-subject-max-mark');
            const streamInput = document.getElementById('new-subject-stream');
            
            const name = nameInput.value.trim();
            const maxMark = parseInt(maxMarkInput.value) || 0;
            const streamFilter = streamInput.value || null;

            if (!name || maxMark <= 0) return;

            const newId = `sub-${Math.random().toString(36).substr(2, 9)}`;
            const subjectToAdd = {
                id: newId,
                name: name,
                maxMark: maxMark,
                streamFilter: streamFilter,
                isComposite: false,
                subSubjects: []
            };

            const updatedSubjects = [...appState.data.subjects, subjectToAdd];

            saveData({ subjects: updatedSubjects });
            nameInput.value = '';
            maxMarkInput.value = 100;
            streamInput.value = '';
        };
        
        const handleSubjectMaxMarkChange = (e) => {
            const subjectId = e.target.dataset.subjectId;
            // Ensure max mark is at least 1
            const newMaxMark = Math.max(1, parseInt(e.target.value) || 1); 

            const updatedSubjects = appState.data.subjects.map(s => {
                if (s.id === subjectId && !s.isComposite) {
                    return { ...s, maxMark: newMaxMark };
                }
                return s;
            });
            saveData({ subjects: updatedSubjects });
        };


        const handleRemoveSubject = async (e) => {
            const idToRemove = e.target.dataset.subjectId;
            const confirmation = await showConfirmationModal(`Are you sure you want to remove this subject? All associated marks will be lost.`);
            if (!confirmation) return;
            
            const updatedSubjects = appState.data.subjects.filter(s => s.id !== idToRemove);
            
            // Also remove the subject's marks from all students
            const updatedStudents = appState.data.students.map(s => {
                const { [idToRemove]: removedMark, ...restMarks } = s.marks;
                return { ...s, marks: restMarks };
            });

            saveData({ subjects: updatedSubjects, students: updatedStudents });
        };

        const handleAddSubSubject = (e) => {
            const subjectId = e.target.dataset.subjectId;
            const newSubjects = appState.data.subjects.map(s => {
                if (s.id === subjectId) {
                    const newSub = { name: `Part ${s.subSubjects.length + 1}`, maxMark: 50 };
                    const newSubs = [...s.subSubjects, newSub];
                    const newMaxMark = newSubs.reduce((sum, ss) => sum + ss.maxMark, 0);
                    return { ...s, subSubjects: newSubs, maxMark: newMaxMark, isComposite: true };
                }
                return s;
            });
            saveData({ subjects: newSubjects });
        };
        
        const handleRemoveSubSubject = (e) => {
            const subjectId = e.target.dataset.subjectId;
            const subSubjectName = e.target.dataset.subsubjectName;

            const newSubjects = appState.data.subjects.map(s => {
                if (s.id === subjectId) {
                    const newSubs = s.subSubjects.filter(ss => ss.name !== subSubjectName);
                    const newMaxMark = newSubs.reduce((sum, ss) => sum + ss.maxMark, 0);
                    // If no sub-subjects remain, turn off isComposite and revert maxMark if needed (here we keep the calculated 0 max mark)
                    return { ...s, subSubjects: newSubs, maxMark: newMaxMark, isComposite: newSubs.length > 0 };
                }
                return s;
            });
            saveData({ subjects: newSubjects });
        };
        
        /** Handles changes to sub-subject name or max mark */
        const handleSubSubjectDetailChange = (e) => {
            const parentId = e.target.dataset.parentId;
            const originalName = e.target.dataset.originalName;
            const field = e.target.dataset.field;
            let value = e.target.value;
            
            if (field === 'maxMark') {
                value = Math.max(1, parseInt(value) || 1);
                e.target.value = value; 
            } else if (field === 'name') {
                value = value.trim();
            }

            const updatedSubjects = appState.data.subjects.map(s => {
                if (s.id === parentId) {
                    const newSubSubjects = s.subSubjects.map(ss => {
                        if (ss.name === originalName) {
                            return { 
                                ...ss, 
                                [field]: field === 'maxMark' ? value : value
                            };
                        }
                        return ss;
                    });
                    
                    // Recalculate parent max mark based on the updated sub-subjects
                    const newMaxMark = newSubSubjects.reduce((sum, ss) => sum + ss.maxMark, 0);
                    
                    return { ...s, subSubjects: newSubSubjects, maxMark: newMaxMark, isComposite: true };
                }
                return s;
            });
            
            // saveData triggers a full re-render, updating data-original-name attribute if the name was changed.
            saveData({ subjects: updatedSubjects });
        };

        /** Handles student deletion */
        const handleDeleteStudent = async (e) => {
            const studentId = e.target.dataset.studentId;
            const studentName = appState.data.students.find(s => s.id === studentId)?.name || 'this student';

            const confirmation = await showConfirmationModal(`Are you sure you want to permanently delete ${studentName} and all their marks?`);
            if (!confirmation) return;

            const updatedStudents = appState.data.students.filter(s => s.id !== studentId);
            
            // Recalculate ranks and save the new list
            saveData({ students: updatedStudents });
        };


        const handleInstDetailChange = (e) => {
            const key = e.target.id.replace('inst-', '');
            const value = e.target.value;
            // The examName input here controls the institution's examName field
            saveData({ institution: { ...appState.data.institution, [key]: value } }, false);
        };

        const handleStudentSelectorChange = (e) => {
            appState.selectedStudentId = e.target.value;
            render();
        };
        
        // --- DOWNLOAD/FILE HANDLERS ---
        
        /** Utility: Downloads a string content as a file */
        const downloadFile = (content, filename, mimeType) => {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        /** Utility: Converts data to a CSV string */
        const convertToCsv = (data, headers) => {
            const csvRows = [];
            csvRows.push(headers.join(','));
            for (const row of data) {
                const values = headers.map(header => {
                    const value = row[header] || '';
                    const formattedValue = ('' + value).replace(/"/g, '""');
                    return formattedValue.includes(',') || formattedValue.includes('"') ? `"${formattedValue}"` : formattedValue;
                });
                csvRows.push(values.join(','));
            }
            return csvRows.join('\n');
        };

        const handleDownloadWholeMarksheet = (format) => {
            if (appState.rankedStudents.length === 0) {
                console.log('Notification: No data to download.');
                return;
            }

            if (format === 'csv') {
                const baseHeaders = ['Rank', 'Name', 'Stream', 'PhotoURL', 'Total Score', 'Total Max Mark', 'Overall Percentage'];
                const subjectHeaders = appState.data.subjects.flatMap(s => [`${s.name} Score`, `${s.name} Grade`, `${s.name} Percentage`]);
                const allHeaders = [...baseHeaders, ...subjectHeaders];

                const csvData = appState.rankedStudents.map(student => {
                    const row = {
                        'Rank': student.rank,
                        'Name': student.name,
                        'Stream': student.stream,
                        'PhotoURL': student.photoUrl,
                        'Total Score': student.total,
                        'Total Max Mark': student.totalMaxMark,
                        'Overall Percentage': student.percentage + '%',
                    };
                    
                    appState.data.subjects.forEach(s => {
                        const markEntry = student.marks[s.id] || {};
                        row[`${s.name} Score`] = markEntry.score || 0;
                        row[`${s.name} Grade`] = markEntry.grade || 'N/A';
                        row[`${s.name} Percentage`] = markEntry.percentage || '0.00';
                    });
                    return row;
                });

                const csvContent = convertToCsv(csvData, allHeaders);
                downloadFile(csvContent, `${appState.data.institution.examName}_Marksheet.csv`, 'text/csv;charset=utf-8;');
            } else if (format === 'pdf') {
                // Trigger the browser's print dialog on the marksheet view
                window.print();
            }
        };

        const handleDownloadIndividualReport = (student, format) => {
            if (format === 'csv') {
                const reportData = [
                    { Key: 'Student Name', Value: student.name },
                    { Key: 'Stream', Value: student.stream },
                    { Key: 'Overall Rank', Value: student.rank },
                    { Key: 'Total Score', Value: student.total },
                    { Key: 'Total Max Mark', Value: student.totalMaxMark },
                    { Key: 'Overall Percentage', Value: `${student.percentage}%` },
                ];
                
                // Only include relevant subjects in the report CSV
                const relevantSubjects = appState.data.subjects.filter(s => !s.streamFilter || s.streamFilter === student.stream);

                relevantSubjects.forEach(s => {
                    const markEntry = student.marks[s.id] || {};
                    reportData.push({ Key: `${s.name} Max Mark`, Value: markEntry.maxMark || 0 });
                    reportData.push({ Key: `${s.name} Score`, Value: markEntry.score || 0 });
                    reportData.push({ Key: `${s.name} Grade`, Value: markEntry.grade || 'N/A' });
                    reportData.push({ Key: `${s.name} Percentage`, Value: `${markEntry.percentage || '0.00'}%` });
                });

                const csvContent = convertToCsv(reportData, ['Key', 'Value']);
                downloadFile(csvContent, `${student.name}_Progress_Report.csv`, 'text/csv;charset=utf-8;');
            } else if (format === 'pdf') {
                // Switch to report view, set student, and trigger print
                appState.selectedStudentId = student.id;
                appState.activeTab = 'reports';
                render();
                setTimeout(() => {
                    window.print();
                }, 100);
            }
        };

        const handleFileUpload = (event) => {
            const file = event.target.files[0];
            const uploadMessageEl = document.getElementById('upload-message');
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const content = e.target.result;
                    const rows = content.trim().split('\n').filter(row => row.trim() !== '');
                    if (rows.length < 1) {
                        uploadMessageEl.textContent = 'File is empty.';
                        return;
                    }
                    
                    const headers = rows[0].split(',').map(h => h.trim());
                    // Expecting: Name, Stream, PhotoURL, Subject1 Name, Subject2 Name, ...
                    const subjectNamesFromCsv = headers.slice(3).map(h => h.trim()).filter(h => h);

                    if (subjectNamesFromCsv.length === 0) {
                        uploadMessageEl.textContent = 'CSV must contain "Name", "Stream", "PhotoURL" and at least one subject mark column.';
                        return;
                    }

                    // 1. Add/Update Subjects
                    const existingSubjectNames = new Set(appState.data.subjects.map(s => s.name));
                    let updatedSubjects = [...appState.data.subjects];

                    subjectNamesFromCsv.forEach(subjectName => {
                        if (!existingSubjectNames.has(subjectName)) {
                            updatedSubjects.push({
                                id: `sub-${Math.random().toString(36).substr(2, 9)}`,
                                name: subjectName,
                                maxMark: 100, // Default max mark for new subjects from CSV
                                streamFilter: null, // Default to Common
                                isComposite: false,
                                subSubjects: []
                            });
                        }
                    });

                    const subjectNameToId = updatedSubjects.reduce((acc, sub) => {
                        acc[sub.name] = sub.id;
                        return acc;
                    }, {});

                    // 2. Process Student Rows (Overwriting existing students is not handled here, assuming new import or clear overwrite)
                    let currentId = appState.data.nextStudentId;
                    const newStudents = rows.slice(1).map(row => {
                        const values = row.split(',').map(v => v.trim());
                        if (values.length < 3) return null;

                        const studentData = {
                            id: `s-${currentId++}`,
                            name: values[0],
                            stream: values[1],
                            photoUrl: values[2] || '',
                            marks: {},
                        };
                        
                        values.slice(3).forEach((scoreStr, index) => {
                            const subjectName = subjectNamesFromCsv[index];
                            const subjectId = subjectNameToId[subjectName];
                            if (subjectId) {
                                // Assuming CSV contains only the final score
                                studentData.marks[subjectId] = { score: parseInt(scoreStr) || 0 };
                            }
                        });

                        return studentData;
                    }).filter(s => s !== null && s.name);

                    saveData({
                        subjects: updatedSubjects,
                        students: newStudents, 
                        nextStudentId: currentId
                    });

                    uploadMessageEl.textContent = `Successfully processed ${newStudents.length} students. New subjects added/updated.`;

                } catch (error) {
                    uploadMessageEl.textContent = `Error processing file: ${error.message}. Check console for details.`;
                    console.error("File processing error:", error);
                }
            };
            reader.readAsText(file);
        };


        /** Attaches all event listeners after a full DOM render */
        const attachEventListeners = () => {
            // --- Sidebar / Exam ---
            document.getElementById('btn-add-exam')?.addEventListener('click', handleAddExam);

            // --- Marksheet Tab ---
            document.getElementById('btn-add-student')?.addEventListener('click', handleAddStudent);
            document.getElementById('csv-upload-input')?.addEventListener('change', handleFileUpload);
            document.getElementById('download-marksheet-csv')?.addEventListener('click', () => handleDownloadWholeMarksheet('csv'));
            document.getElementById('download-marksheet-pdf')?.addEventListener('click', () => handleDownloadWholeMarksheet('pdf'));
            
            // Dynamic Mark Inputs
            document.querySelectorAll('.mark-input').forEach(input => {
                input.addEventListener('input', handleMarkChange);
            });
            document.querySelectorAll('.sub-mark-input').forEach(input => {
                input.addEventListener('input', handleSubMarkChange);
            });
            document.querySelectorAll('.view-report-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    appState.selectedStudentId = e.target.dataset.studentId;
                    setActiveTab('reports');
                });
            });
            
            // Student Delete Button
            document.querySelectorAll('.delete-student-btn').forEach(button => {
                button.addEventListener('click', handleDeleteStudent);
            });


            // --- Reports Tab ---
            document.getElementById('student-selector')?.addEventListener('change', handleStudentSelectorChange);
            const selectedStudent = appState.rankedStudents.find(s => s.id === appState.selectedStudentId);
            if (selectedStudent) {
                document.getElementById('download-report-csv')?.addEventListener('click', () => handleDownloadIndividualReport(selectedStudent, 'csv'));
                document.getElementById('download-report-pdf')?.addEventListener('click', () => handleDownloadIndividualReport(selectedStudent, 'pdf'));
            }

            // --- Settings Tab ---
            document.getElementById('inst-name')?.addEventListener('input', handleInstDetailChange);
            document.getElementById('inst-address')?.addEventListener('input', handleInstDetailChange);
            document.getElementById('inst-logo-url')?.addEventListener('input', handleInstDetailChange);
            document.getElementById('inst-examName')?.addEventListener('input', handleInstDetailChange);
            document.getElementById('btn-add-subject')?.addEventListener('click', handleAddSubject);
            
            document.querySelectorAll('.remove-subject-btn').forEach(btn => btn.addEventListener('click', handleRemoveSubject));
            document.querySelectorAll('.add-subsubject-btn').forEach(btn => btn.addEventListener('click', handleAddSubSubject));
            document.querySelectorAll('.remove-subsubject-btn').forEach(btn => btn.addEventListener('click', handleRemoveSubSubject));
            
            // Max Mark Change Handler for simple subjects
            document.querySelectorAll('.subject-max-mark-input').forEach(input => {
                input.addEventListener('input', handleSubjectMaxMarkChange);
            });
            
            // Sub-subject detail change handler (name or mark)
            document.querySelectorAll('.subsubject-detail-input').forEach(input => {
                input.addEventListener('input', handleSubSubjectDetailChange);
            });
        };

        // --- INITIALIZATION ---
        window.onload = () => {
            window.setActiveTab = setActiveTab; // Expose to global scope for sidebar buttons
            setupModalListeners(); // Set up confirmation modal handlers
            initializeLocalData();
        };

    </script>
</body>
</html>
